@using TaskManagement.Models
@model TaskManagement.Models.Project

@{
    ViewData["Title"] = Model.Title;
    Layout = null; // No layout to ensure full page control for this prototype, or standard layout? 
                   // User said "Container: white-space: nowrap... height: 100vh". Better to exclude Layout or override deeply.
                   // I'll assume Standalone page for vertical slice perfection.
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TaskManagement</title>
    <link rel="stylesheet" href="~/css/board.css" />
</head>
<body>

<div class="board-wrapper">
    <div class="board-header">
        @Model.Title
    </div>
    
    <div class="board-canvas">
        @{
            var columns = ViewBag.Columns as List<string>;
            int colIndex = 0;
        }

        @foreach (var colTitle in columns)
        {
            // Map string columns to Enum ID if possible, or use index
            // For this prototype, we assume first 3 are Enum mapped: 0, 1, 2
            // Custom ones will have higher indices, which might not map to TaskStatusEnum perfectly for 'Add Card'
            // But we will use the index as ID for now.
            int currentId = colIndex; 
            
            <div class="list-wrapper">
                <div class="list">
                    <div class="list-header">
                        @colTitle
                    </div>
                    
                    <div class="list-cards" ondrop="drop(event, '@colTitle')" ondragover="allowDrop(event)">
                        @foreach (var task in Model.Tasks
                            .Where(t => t.ColumnName == colTitle && t.Title != "__COLUMN_PLACEHOLDER__")
                            .OrderBy(t => t.Order))
                        {
                            <div class="list-card" draggable="true" ondragstart="drag(event, '@task.Id')" data-task-id="@task.Id">
                                <div class="list-card-details">
                                    <div class="card-check-btn @(task.IsCompleted ? "checked" : "")" onclick="toggleTask(event, @task.Id)">
                                        @(task.IsCompleted ? "✓" : "")
                                    </div>

                                    @if(task.Priority == PriorityEnum.High)
                                    {
                                        <div class="badge badge-high" title="High Priority"></div>
                                    }
                                    else if (task.Priority == PriorityEnum.Medium)
                                    {
                                         <div class="badge badge-medium" title="Medium Priority"></div>
                                    }
                                    else if (task.Priority == PriorityEnum.Low)
                                    {
                                         <div class="badge badge-low" title="Low Priority"></div>
                                    }
                                    
                                    <span class="list-card-title @(task.IsCompleted ? "completed-task" : "")" id="title-@task.Id">@task.Title</span>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Add Card Footer -->
                    <div class="card-composer-container">
                        <a class="open-card-composer" id="open-composer-@currentId" href="javascript:void(0)" onclick="toggleComposer(@currentId, true)">
                            + Add a card
                        </a>
                        
                        <div class="card-composer" id="composer-@currentId">
                            <form method="post" action="/Board/AddCard">
                                <input type="hidden" name="projectId" value="@Model.Id" />
                                <input type="hidden" name="columnName" value="@colTitle" />
                                <textarea class="composer-textarea" name="title" placeholder="Enter a title for this card..." autofocus></textarea>
                                
                                <div class="composer-controls">
                                    <button type="submit" class="confirm-add-card">Add Card</button>
                                    <div class="cancel-add-card" onclick="toggleComposer(@currentId, false)">×</div>
                                </div>
                                <select name="priority" style="margin-top: 4px; border: none; background: transparent; color: #5e6c84; font-size: 12px;">
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            colIndex++;
        }

        <!-- Add Another List Button -->
        <div class="list-wrapper add-list-wrapper">
            <div class="add-list-container">
                <a class="open-add-list" id="open-add-list" href="javascript:void(0)" onclick="toggleAddList(true)">
                    + Add another list
                </a>
                <div class="add-list-form" id="add-list-form" style="display:none;">
                    <form method="post" action="/Board/AddColumn">
                        <input type="hidden" name="projectId" value="@Model.Id" />
                        <input type="text" class="list-name-input" name="title" placeholder="Enter list title..." autofocus autocomplete="off" />
                        <div class="composer-controls">
                            <button type="submit" class="confirm-add-card">Add List</button>
                            <div class="cancel-add-card" onclick="toggleAddList(false)">×</div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleComposer(columnId, show) {
        var openBtn = document.getElementById('open-composer-' + columnId);
        var composer = document.getElementById('composer-' + columnId);
        
        if (show) {
            openBtn.style.display = 'none';
            composer.style.display = 'block';
            composer.querySelector('textarea').focus();
        } else {
            openBtn.style.display = 'block';
            composer.style.display = 'none';
        }
    }

    function toggleAddList(show) {
        var openBtn = document.getElementById('open-add-list');
        var form = document.getElementById('add-list-form');

        if (show) {
            openBtn.style.display = 'none';
            form.style.display = 'block';
            form.querySelector('input').focus();
        } else {
            openBtn.style.display = 'block';
            form.style.display = 'none';
        }
    }

    // Drag and Drop Logic
    function allowDrop(ev) {
        ev.preventDefault();
        
        var container = ev.target.closest('.list-cards');
        if (!container) return;

        var afterElement = getDragAfterElement(container, ev.clientY);
        var draggable = document.querySelector('.dragging');
        
        if (draggable) {
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
        }
    }

    function drag(ev, taskId) {
        ev.dataTransfer.setData("text", taskId);
        ev.target.classList.add('dragging');
    }
    
    // Add event listener for dragend to remove class
    document.addEventListener('dragend', function(event) {
        if(event.target.classList.contains('list-card')) {
             event.target.classList.remove('dragging');
        }
    });

    function getDragAfterElement(container, y) {
        // querySelectorAll does not return an array
        var draggableElements = [...container.querySelectorAll('.list-card:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            var box = child.getBoundingClientRect();
            var offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function drop(ev, targetColumn) {
        ev.preventDefault();
        var taskId = ev.dataTransfer.getData("text");
        
        // Visual DOM already handled by dragover (allowDrop) mostly, 
        // but we need to ensure the final calculation is correct and get the index.
        
        var container = ev.target.closest('.list-cards');
        var cardElement = document.querySelector(`.list-card[data-task-id='${taskId}']`);
        
        if (container && cardElement) {
             // It might already be there due to dragover visual updates
             // Calculate index
             var index = [...container.querySelectorAll('.list-card')].indexOf(cardElement);
             
             // Call API with index
             fetch('/Board/MoveCard?taskId=' + taskId + '&targetColumn=' + targetColumn + '&index=' + index, { method: 'POST' });
        }
        
        if(cardElement) cardElement.classList.remove('dragging');
    }

    // Check Logic
    function toggleTask(ev, taskId) {
        ev.preventDefault();
        ev.stopPropagation(); // Prevent card open
        
        var btn = ev.target.closest('.card-check-btn');
        var title = document.getElementById('title-' + taskId);
        
        // Toggle visual state
        if (btn.classList.contains('checked')) {
            btn.classList.remove('checked');
            btn.innerText = '';
            title.classList.remove('completed-task');
        } else {
            btn.classList.add('checked');
            btn.innerText = '✓';
            title.classList.add('completed-task');
        }

        // Call API
        fetch('/Board/ToggleCard?taskId=' + taskId, { method: 'POST' });
    }

    // Enter to Submit in Composer
    document.addEventListener('keydown', function(event) {
        if (event.target.classList.contains('composer-textarea')) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                event.target.closest('form').querySelector('button[type="submit"]').click();
            }
        }
    });

    // Initialize drag logic (optional if not strictly needed since we use ondragstart attributes)
</script>

</body>
</html>
