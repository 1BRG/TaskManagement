@using TaskManagement.Models
@model TaskManagement.Models.Project

@{
    ViewData["Title"] = Model.Title;
    Layout = null; 
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TaskManagement</title>
    <!-- New Premium Theme -->
    <link rel="stylesheet" href="~/css/_kanban_theme.css" />
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

    <div class="board-wrapper">
        <header class="board-header">
            <a asp-action="Index" asp-controller="Home" class="nav-item">
                <i class="bi bi-arrow-left-short"></i> @Model.Title
            </a>
        </header>

        <div class="board-canvas">
            @{
                var columns = Model.Columns;
            }

            @foreach (var col in columns)
            {
                <div class="list-wrapper" id="column-@col.Id">
                    <div class="list">
                        <div class="list-header">
                            <span class="list-title-text">@col.Title</span>
                            <span class="badge" style="background: rgba(0,0,0,0.05); color: #64748b; margin:0;">@col.Tasks.Count</span>
                        </div>

                        <div class="list-cards" ondrop="drop(event, @col.Id)" ondragover="allowDrop(event)">
                            @foreach (var task in col.Tasks.OrderBy(t => t.Order))
                            {
                                <!-- Usage of Partial View for Card -->
                                <partial name="_CardPartial" model="task" />
                            }
                        </div>

                        <!-- Add Card Footer -->
                        <div class="card-composer-container">
                            <a class="open-card-composer" id="open-composer-@col.Id" href="javascript:void(0)" onclick="toggleComposer(@col.Id, true)">
                                <i class="bi bi-plus"></i> Add a card
                            </a>

                            <div class="card-composer" id="composer-@col.Id">
                                <form method="post" action="/Board/AddCard" enctype="multipart/form-data">
                                    <input type="hidden" name="projectId" value="@Model.Id" />
                                    <input type="hidden" name="columnId" value="@col.Id" />
                                    <textarea class="composer-textarea" name="title" placeholder="What needs to be done?" autofocus></textarea>

                                    <div class="composer-controls">
                                        <button type="submit" class="confirm-add-card">Add Card</button>
                                        <div class="cancel-add-card" onclick="toggleComposer(@col.Id, false)">
                                            <i class="bi bi-x"></i>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Add Another List Input -->
            <div class="list-wrapper add-list-wrapper">
                <div class="add-list-container">
                    <a class="open-add-list" id="open-add-list" href="javascript:void(0)" onclick="toggleAddList(true)">
                        <i class="bi bi-plus-lg"></i> Add another list
                    </a>
                    <div class="add-list-form" id="add-list-form" style="display:none;">
                        <form method="post" action="/Board/AddColumn">
                            <input type="hidden" name="projectId" value="@Model.Id" />
                            <input type="text" class="list-name-input" name="title" placeholder="List title..." autofocus autocomplete="off" />
                            <div class="composer-controls">
                                <button type="submit" class="confirm-add-card">Add List</button>
                                <div class="cancel-add-card" onclick="toggleAddList(false)">
                                    <i class="bi bi-x"></i>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Archive Hub Overlay -->
    <div id="archive-hub" class="archive-hub-overlay" style="display:none;" onclick="if(event.target === this) closeArchiveHub()">
        <div class="archive-hub-panel">
            <div class="archive-header">
                <h3><i class="bi bi-archive"></i> Archived Cards</h3>
                <button onclick="closeArchiveHub()" title="Close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="archive-search">
                <i class="bi bi-search"></i>
                <input type="text" id="archive-search-input" placeholder="Search archived cards..." oninput="searchArchive(this.value)" />
            </div>
            <div class="archive-list" id="archive-hub-content">
                <!-- Loaded via AJAX -->
            </div>
        </div>
    </div>
    
    <!-- Header Actions -->
    <div class="board-header-actions" style="position:fixed; top: 12px; right: 20px; z-index: 1000; display: flex; gap: 8px;">
         <button class="btn-insights-toggle" onclick="toggleInsightsPanel()" title="AI Project Insights">
             <i class="bi bi-lightbulb"></i> AI Insights
         </button>
         <button class="btn-archive-toggle" onclick="toggleArchiveHub()" title="Open Archive">
             <i class="bi bi-archive"></i> Archive
         </button>
    </div>

    <!-- AI Insights Panel -->
    <div id="insights-panel" class="insights-overlay" style="display:none;" onclick="if(event.target === this) closeInsightsPanel()">
        <div class="insights-panel-content">
            <div class="insights-header">
                <h3><i class="bi bi-lightbulb-fill"></i> AI Project Strategist</h3>
                <button onclick="closeInsightsPanel()" title="Close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="insights-body" id="insights-body">
                <div class="insights-placeholder">
                    <i class="bi bi-stars"></i>
                    <p>Click below to generate AI-powered insights about your project.</p>
                    <button class="btn-generate-insights" onclick="generateInsights()">
                        <i class="bi bi-magic"></i> Analyze Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="task-modal" class="modal-overlay" style="display:none;" onclick="if(event.target === this) closeModal()">
        <div class="modal-content-glass">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modal-loading" style="display:none; text-align:center; padding: 40px;">
                 <div class="spinner-border text-light" role="status"></div>
            </div>
            <div id="modal-body-content">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // Global State for Modal
        let currentTaskId = 0;
        let didModifyTask = false;

        function toggleComposer(columnId, show) {
            var openBtn = document.getElementById('open-composer-' + columnId);
            var composer = document.getElementById('composer-' + columnId);

            if (show) {
                openBtn.style.display = 'none';
                composer.style.display = 'block';
                var textarea = composer.querySelector('textarea');
                textarea.focus(); 
                textarea.value = ''; 
            } else {
                openBtn.style.display = 'flex'; 
                composer.style.display = 'none';
            }
        }

        function toggleAddList(show) {
            var openBtn = document.getElementById('open-add-list');
            var form = document.getElementById('add-list-form');
            var container = openBtn.parentElement;

            if (show) {
                openBtn.style.display = 'none';
                form.style.display = 'block';
                form.querySelector('input').focus();
                container.style.background = 'transparent';
                container.style.backdropFilter = 'none';
            } else {
                openBtn.style.display = 'block';
                form.style.display = 'none';
                container.style.background = 'rgba(255, 255, 255, 0.3)';
                container.style.backdropFilter = 'blur(8px)';
            }
        }

        // Drag and Drop Logic 
        function allowDrop(ev) {
            ev.preventDefault();
            var container = ev.target.closest('.list-cards');
            if (!container) return;
            var afterElement = getDragAfterElement(container, ev.clientY);
            var draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            }
        }

        function drag(ev, taskId) {
            if(ev.target.closest('.card-check-btn') || ev.target.closest('.list-card-details')) {
                // Allow drag
            }
            ev.dataTransfer.setData("text", taskId);
            ev.target.classList.add('dragging');
        }

        document.addEventListener('dragend', function(event) {
            if(event.target && event.target.classList && event.target.classList.contains('list-card')) {
                 event.target.classList.remove('dragging');
            }
            var draggingItems = document.querySelectorAll('.dragging');
            draggingItems.forEach(i => i.classList.remove('dragging'));
        });

        function getDragAfterElement(container, y) {
            var draggableElements = [...container.querySelectorAll('.list-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                var box = child.getBoundingClientRect();
                var offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function drop(ev, targetColumnId) {
            ev.preventDefault();
            var taskId = ev.dataTransfer.getData("text");
            var container = ev.target.closest('.list-cards');
            var cardElement = document.querySelector(`.list-card[data-task-id='${taskId}']`);
            if (container && cardElement) {
                 var index = [...container.querySelectorAll('.list-card')].indexOf(cardElement);
                 fetch('/Board/MoveCard?taskId=' + taskId + '&targetColumnId=' + targetColumnId + '&index=' + index, { method: 'POST' });
            }
            if(cardElement) cardElement.classList.remove('dragging');
        }

        function toggleTask(ev, taskId) {
            ev.preventDefault();
            ev.stopPropagation(); 
            var btn = ev.target.closest('.card-check-btn');
            var title = document.getElementById('title-' + taskId);
            if (btn.classList.contains('checked')) {
                btn.classList.remove('checked');
                title.classList.remove('completed-task');
            } else {
                btn.classList.add('checked');
                title.classList.add('completed-task');
            }
            fetch('/Board/ToggleCard?taskId=' + taskId, { method: 'POST' });
        }
        
        // Modal Logic
        document.addEventListener('click', function(e) {
            var card = e.target.closest('.list-card');
            if (card && !e.target.closest('.card-check-btn') && !e.target.closest('a')) {
                 var taskId = card.getAttribute('data-task-id');
                 openModalFetch(taskId);
            }
        });
        
        async function openModalFetch(taskId) {
            var modal = document.getElementById('task-modal');
            var content = document.getElementById('modal-body-content');
            var loading = document.getElementById('modal-loading');
            
            modal.style.display = 'flex';
            content.style.display = 'none';
            loading.style.display = 'block';
            currentTaskId = taskId;
            didModifyTask = false;

            try {
                let response = await fetch('/Board/GetTaskDetails?taskId=' + taskId);
                let data = await response.json();
                renderModalContent(data);
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (err) {
                console.error(err);
                loading.style.display = 'none';
            }
        }
        
        function renderModalContent(task) {
            var content = document.getElementById('modal-body-content');
            
            // Labels
            let labelsHtml = task.labels.map(l => 
                `<span class="card-label-lg" style="background:${l.color};">${l.name}</span>`
            ).join('');
            
            // Images
            let imagesHtml = task.images.map(img => 
                `<a href="${img.filePath}" target="_blank"><img src="${img.filePath}" class="modal-attachment-preview" /></a>`
            ).join('');
            
            content.innerHTML = `
                <div class="modal-header-row">
                     <i class="bi bi-card-heading modal-icon-lg"></i>
                     <h2 class="modal-title" contenteditable="true" 
                         onblur="updateTitle(${task.id}, this.innerText)"
                         onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}">
                         ${task.title}
                     </h2>
                </div>
                
                <div class="modal-grid">
                    <div class="modal-main">
                        <div class="modal-section">
                            <h3><i class="bi bi-text-left"></i> Description</h3>
                            <div class="description-editor">
                                <textarea class="modal-description-input" 
                                          placeholder="Add a more detailed description..."
                                          onblur="updateDescription(${task.id}, this.value)"
                                          oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                          onkeydown="if(event.key==='Enter' && (event.ctrlKey || event.metaKey)){event.preventDefault(); this.blur();}">${task.description || ''}</textarea>
                                <div class="modal-helper-text">Press <strong>Ctrl+Enter</strong> to save</div>
                            </div>
                        </div>
                        
                        <div class="modal-section">
                            <h3><i class="bi bi-paperclip"></i> Attachments</h3>
                            <div class="modal-attachments" id="modal-attachments-${task.id}">
                                ${imagesHtml}
                                <div class="upload-box" onclick="triggerUpload(${task.id})">
                                    <i class="bi bi-plus-lg"></i> Add Image
                                    <input type="file" id="upload-${task.id}" hidden onchange="uploadImage(${task.id}, this)" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-sidebar">
                        <div class="modal-section">
                             <h3>Labels</h3>
                             <div class="modal-labels-list" id="modal-labels-${task.id}">
                                 ${labelsHtml}
                                 <button class="add-label-btn" onclick="showLabelInput(${task.id})"><i class="bi bi-plus"></i></button>
                             </div>
                             <div class="label-input-wrapper" id="label-input-wrapper-${task.id}" style="display:none; margin-top:8px;">
                                 <input type="text" class="label-input-sm" id="new-label-${task.id}" placeholder="Label name" onkeydown="if(event.key==='Enter') addLabel(${task.id})" />
                             </div>
                        </div>

                         <div class="modal-section">
                             <h3>Actions</h3>
                             <button class="modal-btn-action" onclick="performArchive(${task.id})"><i class="bi bi-archive"></i> Archive</button>
                        </div>
                        
                        <div class="modal-section">
                             <h3>Assignee</h3>
                             <div class="assignee-selector">
                                 ${
                                    task.assignedToUserId === '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value' 
                                    ? `<button id="btn-assign-${task.id}" class="modal-btn-action" onclick="unassignTask(${task.id})"><i class="bi bi-person-x"></i> Unassign Me</button>`
                                    : `<button id="btn-assign-${task.id}" class="modal-btn-action" onclick="assignToMe(${task.id})"><i class="bi bi-person-plus"></i> Assign to Me</button>`
                                 }
                             </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Auto-resize textarea initially
            setTimeout(() => {
                let ta = content.querySelector('textarea');
                if(ta) { ta.style.height = (ta.scrollHeight) + 'px'; }
            }, 10);
        }

        async function closeModal() {
            document.getElementById('task-modal').style.display = 'none';
            if(didModifyTask && currentTaskId > 0) {
                 await refreshCard(currentTaskId);
            }
            currentTaskId = 0;
        }
        
        // Live Update Logic: Refresh single card
        async function refreshCard(taskId) {
            try {
                let res = await fetch('/Board/GetCardHtml?taskId=' + taskId);
                if(res.ok) {
                    let html = await res.text();
                    let card = document.querySelector(`.list-card[data-task-id='${taskId}']`);
                    if(card) {
                        card.outerHTML = html;
                    }
                } else {
                    // Task might be archived or deleted
                    let card = document.querySelector(`.list-card[data-task-id='${taskId}']`);
                    if(card && res.status === 404) {
                         // Likely archived, animate vanish?
                         card.remove(); 
                    }
                }
            } catch(e) { console.error("Update failed", e); }
        }

        async function updateTitle(taskId, newTitle) {
            // Implementation pending for Title update endpoint if strictly needed, 
            // but for now relying on existing mechanisms or adding one is better.
            // Assuming we added UpdateTaskDescription, likely need UpdateTaskTitle.
            // For now, let's allow Description update as primary.
             didModifyTask = true;
        }

        async function updateDescription(taskId, text) {
             let formData = new FormData();
             formData.append('taskId', taskId);
             formData.append('description', text);
             await fetch('/Board/UpdateTaskDescription', { method: 'POST', body: formData });
             didModifyTask = true;
        }
        
        function showLabelInput(taskId) {
            document.getElementById(`label-input-wrapper-${taskId}`).style.display = 'block';
            document.getElementById(`new-label-${taskId}`).focus();
        }
        
        async function addLabel(taskId) {
            let input = document.getElementById(`new-label-${taskId}`);
            let name = input.value;
            if(!name) return;
            
            let formData = new FormData();
            formData.append('taskId', taskId);
            formData.append('name', name);
            
            let res = await fetch('/Board/AddLabel', { method: 'POST', body: formData });
            if(res.ok) {
                let label = await res.json();
                let span = document.createElement('span');
                span.className = 'card-label-lg';
                span.style.background = label.color;
                span.innerText = label.name;
                
                let list = document.getElementById(`modal-labels-${taskId}`);
                // Insert before the button
                list.insertBefore(span, list.lastElementChild);
                
                input.value = '';
                input.parentElement.style.display = 'none';
                didModifyTask = true;
            }
        }

        function triggerUpload(taskId) {
            document.getElementById('upload-' + taskId).click();
        }

        async function uploadImage(taskId, input) {
            if(input.files && input.files[0]) {
                let formData = new FormData();
                formData.append('taskId', taskId);
                formData.append('file', input.files[0]);
                
                let res = await fetch('/Board/UploadTaskImage', { method: 'POST', body: formData });
                if(res.ok) {
                    let json = await res.json();
                    let imgLink = document.createElement('a');
                    imgLink.href = json.filePath;
                    imgLink.target = '_blank';
                    
                    let img = document.createElement('img');
                    img.src = json.filePath;
                    img.className = 'modal-attachment-preview';
                    imgLink.appendChild(img);
                    
                    document.getElementById('modal-attachments-' + taskId).insertBefore(imgLink, input.parentElement);
                    didModifyTask = true;
                }
            }
        }
        
        // --- Archive & Shortcuts ---
        async function performArchive(taskId) {
            if(!taskId) return;
            
            // Optimistic UI
            let card = document.querySelector(`.list-card[data-task-id='${taskId}']`);
            if(card) {
                card.style.transition = "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
                card.style.transform = "scale(0.9) translateY(10px)";
                card.style.opacity = "0";
                setTimeout(() => card.remove(), 300);
            }
            
            didModifyTask = false;
            if(currentTaskId == taskId) {
                closeModal();
            }

            await fetch('/Board/ArchiveTask?taskId=' + taskId, { method: 'POST' });
        }
        
        async function updateCardOnBoard(taskId) {
            let res = await fetch('/Board/GetCardHtml?taskId=' + taskId);
            if(res.ok) {
                let html = await res.text();
                let oldCard = document.querySelector(`.list-card[data-task-id='${taskId}']`);
                if(oldCard) {
                     let temp = document.createElement('div');
                     temp.innerHTML = html;
                     let newCard = temp.firstElementChild;
                     oldCard.replaceWith(newCard);
                     
                     // Animation to highlight change
                     newCard.style.animation = 'fadeIn 0.5s ease';
                }
            }
        }

        async function assignToMe(taskId) {
             let userId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value'; 
             await fetch('/Board/AssignTask?taskId=' + taskId + '&userId=' + userId, { method: 'POST' });
             didModifyTask = true;
             
             // Update Button UI
             let btn = document.getElementById('btn-assign-' + taskId);
             if(btn) {
                 btn.innerHTML = '<i class="bi bi-person-x"></i> Unassign Me';
                 btn.onclick = () => unassignTask(taskId);
             }
             
             // Immediate Board Sync
             updateCardOnBoard(taskId);
        }
        
        async function unassignTask(taskId) {
             await fetch('/Board/AssignTask?taskId=' + taskId + '&userId=unassigned', { method: 'POST' });
             didModifyTask = true;
             
             // Update Button UI
             let btn = document.getElementById('btn-assign-' + taskId);
             if(btn) {
                 btn.innerHTML = '<i class="bi bi-person-plus"></i> Assign to Me';
                 btn.onclick = () => assignToMe(taskId);
             }
             
             // Immediate Board Sync
             updateCardOnBoard(taskId);
        }

        async function restoreTask(taskId, columnId) {
             // UI Idempotency: Disable button
             let btn = event.target.closest('button');
             if(btn) btn.disabled = true;
             
             let item = event.target.closest('.archive-item');
             if(item) {
                 item.style.opacity = '0.5';
                 item.style.pointerEvents = 'none';
             }

             let res = await fetch('/Board/RestoreTask?taskId=' + taskId, { method: 'POST' });
             if(res.ok || res.status === 304) {
                 // Live Restore: Fetch Card HTML
                 let htmlRes = await fetch('/Board/GetCardHtml?taskId=' + taskId);
                 if(htmlRes.ok) {
                     let html = await htmlRes.text();
                     
                     // Find column
                     let col = document.querySelector(`#column-${columnId} .list-cards`);
                     if(col) {
                         // Check for duplicates
                         if(col.querySelector(`.list-card[data-task-id='${taskId}']`)) return;

                         // Create temp container to turn string into node
                         let temp = document.createElement('div');
                         temp.innerHTML = html;
                         let card = temp.firstElementChild;
                         
                         // Animation setup
                         card.style.opacity = '0';
                         card.style.transform = 'scale(0.9)';
                         card.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                         
                         col.insertBefore(card, col.firstChild); // Add to top for visibility
                         
                         // Trigger anim
                         // Force reflow
                         void card.offsetWidth;
                         card.style.opacity = '1';
                         card.style.transform = 'scale(1)';
                     }
                 }
                 
                 // Remove from Hub with anim
                 if(item) {
                     item.style.transform = 'translateX(100px)';
                     item.style.opacity = '0';
                     setTimeout(() => item.remove(), 200);
                 }
             }
        }

        // --- Archive Hub Functions ---
        function toggleArchiveHub() {
            let hub = document.getElementById('archive-hub');
            if(hub.style.display === 'none' || hub.style.display === '') {
                loadArchiveContent();
                hub.style.display = 'flex';
            } else {
                closeArchiveHub();
            }
        }
        
        function closeArchiveHub() {
            document.getElementById('archive-hub').style.display = 'none';
        }
        
        async function loadArchiveContent(query = '') {
            let content = document.getElementById('archive-hub-content');
            content.innerHTML = '<div style="padding:20px; text-align:center; color:#64748b;">Loading...</div>';
            
            let res = await fetch('/Board/GetArchivedTasks?projectId=@Model.Id&query=' + encodeURIComponent(query));
            if(res.ok) {
                content.innerHTML = await res.text();
            } else {
                content.innerHTML = '<div style="padding:20px; text-align:center; color:#64748b;">Failed to load archived tasks</div>';
            }
        }
        
        function searchArchive(query) {
            loadArchiveContent(query);
        }
        
        // Handle Escape key for Archive Hub
        document.addEventListener('keydown', function(event) {
            if(event.key === 'Escape') {
                closeArchiveHub();
                closeInsightsPanel();
                closeModal();
            }
        });

        // --- AI Insights Panel ---
        function toggleInsightsPanel() {
            let panel = document.getElementById('insights-panel');
            if(panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'flex';
            } else {
                closeInsightsPanel();
            }
        }
        
        function closeInsightsPanel() {
            document.getElementById('insights-panel').style.display = 'none';
        }
        
        async function generateInsights() {
            let body = document.getElementById('insights-body');
            
            // Show loading state
            body.innerHTML = `
                <div class="insights-loading">
                    <div class="loading-spinner"></div>
                    <p>Analyzing your project...</p>
                    <span>This may take a few moments</span>
                </div>
            `;
            
            try {
                let res = await fetch('/Board/GetProjectInsights?projectId=@Model.Id');
                let data = await res.json();
                
                if(data.success) {
                    // Render markdown-like content
                    body.innerHTML = `
                        <div class="insights-content">
                            ${renderMarkdown(data.insights)}
                        </div>
                        <div class="insights-footer">
                            <button class="btn-regenerate" onclick="generateInsights()">
                                <i class="bi bi-arrow-clockwise"></i> Regenerate
                            </button>
                        </div>
                    `;
                } else {
                    body.innerHTML = `<div class="insights-error"><i class="bi bi-exclamation-triangle"></i> Failed to generate insights</div>`;
                }
            } catch(e) {
                body.innerHTML = `<div class="insights-error"><i class="bi bi-exclamation-triangle"></i> ${e.message}</div>`;
            }
        }
        
        function renderMarkdown(text) {
            // Simple markdown-to-HTML conversion
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^# (.+)$/gm, '<h2>$1</h2>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, function(match) {
                    if(match.startsWith('<')) return match;
                    return match;
                });
        }

    </script>
</body>
</html>
