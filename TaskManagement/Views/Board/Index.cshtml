@using TaskManagement.Models
@model TaskManagement.Models.Project

@{
    ViewData["Title"] = Model.Title;
    Layout = null; 
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TaskManagement</title>
    <!-- New Premium Theme -->
    <link rel="stylesheet" href="~/css/_kanban_theme.css" />
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

    <div class="board-wrapper">
        <header class="board-header">
            <a asp-action="Index" asp-controller="Home" class="nav-item">
                <i class="bi bi-arrow-left-short"></i> @Model.Title
            </a>
        </header>

        <div class="board-canvas">
            @{
                var columns = Model.Columns;
            }

            @foreach (var col in columns)
            {
                <div class="list-wrapper">
                    <div class="list">
                        <div class="list-header">
                            <span class="list-title-text">@col.Title</span>
                            <span class="badge" style="background: rgba(0,0,0,0.05); color: #64748b; margin:0;">@col.Tasks.Count</span>
                        </div>

                        <div class="list-cards" ondrop="drop(event, @col.Id)" ondragover="allowDrop(event)">
                            @foreach (var task in col.Tasks.OrderBy(t => t.Order))
                            {
                                <div class="list-card" draggable="true" ondragstart="drag(event, '@task.Id')" data-task-id="@task.Id">
                                    <div class="card-check-btn @(task.IsCompleted ? "checked" : "")" onclick="toggleTask(event, @task.Id)">
                                        <i class="bi bi-check" style="pointer-events: none;"></i>
                                    </div>
                                    
                                    <div class="list-card-details">
                                        @if (task.Priority == PriorityEnum.High)
                                        {
                                            <div class="badge badge-high">High</div>
                                        }
                                        else if (task.Priority == PriorityEnum.Medium)
                                        {
                                            <div class="badge badge-medium">Medium</div>
                                        }
                                        else if (task.Priority == PriorityEnum.Low)
                                        {
                                            <div class="badge badge-low">Low</div>
                                        }

                                        <span class="list-card-title @(task.IsCompleted ? "completed-task" : "")" id="title-@task.Id">@task.Title</span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Add Card Footer -->
                        <div class="card-composer-container">
                            <a class="open-card-composer" id="open-composer-@col.Id" href="javascript:void(0)" onclick="toggleComposer(@col.Id, true)">
                                <i class="bi bi-plus"></i> Add a card
                            </a>

                            <div class="card-composer" id="composer-@col.Id">
                                <form method="post" action="/Board/AddCard">
                                    <input type="hidden" name="projectId" value="@Model.Id" />
                                    <input type="hidden" name="columnId" value="@col.Id" />
                                    <textarea class="composer-textarea" name="title" placeholder="What needs to be done?" autofocus></textarea>
                                    
                                    <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 8px;">
                                        <select name="priority" class="composer-select">
                                            <option value="Low">Low Priority</option>
                                            <option value="Medium" selected>Medium Priority</option>
                                            <option value="High">High Priority</option>
                                        </select>
                                    </div>

                                    <div class="composer-controls">
                                        <button type="submit" class="confirm-add-card">Add Card</button>
                                        <div class="cancel-add-card" onclick="toggleComposer(@col.Id, false)">
                                            <i class="bi bi-x"></i>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Add Another List Input -->
            <div class="list-wrapper add-list-wrapper">
                <div class="add-list-container">
                    <a class="open-add-list" id="open-add-list" href="javascript:void(0)" onclick="toggleAddList(true)">
                        <i class="bi bi-plus-lg"></i> Add another list
                    </a>
                    <div class="add-list-form" id="add-list-form" style="display:none;">
                        <form method="post" action="/Board/AddColumn">
                            <input type="hidden" name="projectId" value="@Model.Id" />
                            <input type="text" class="list-name-input" name="title" placeholder="List title..." autofocus autocomplete="off" />
                            <div class="composer-controls">
                                <button type="submit" class="confirm-add-card">Add List</button>
                                <div class="cancel-add-card" onclick="toggleAddList(false)">
                                    <i class="bi bi-x"></i>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic Script (Unchanged Logic, just Icon tweaks) -->
    <script>
        function toggleComposer(columnId, show) {
            var openBtn = document.getElementById('open-composer-' + columnId);
            var composer = document.getElementById('composer-' + columnId);

            if (show) {
                openBtn.style.display = 'none';
                composer.style.display = 'block';
                var textarea = composer.querySelector('textarea');
                textarea.focus(); 
                textarea.value = ''; // Clear on open
            } else {
                openBtn.style.display = 'flex'; // Changed from block to flex for centering
                composer.style.display = 'none';
            }
        }

        function toggleAddList(show) {
            var openBtn = document.getElementById('open-add-list');
            var form = document.getElementById('add-list-form');
            var container = openBtn.parentElement;

            if (show) {
                openBtn.style.display = 'none';
                form.style.display = 'block';
                form.querySelector('input').focus();
                container.style.background = 'transparent'; // Hide container bg when form is open
                container.style.backdropFilter = 'none';
            } else {
                openBtn.style.display = 'block';
                form.style.display = 'none';
                container.style.background = 'rgba(255, 255, 255, 0.3)'; // Restore style
                container.style.backdropFilter = 'blur(8px)';
            }
        }

        // Drag and Drop Logic
        function allowDrop(ev) {
            ev.preventDefault();
            var container = ev.target.closest('.list-cards');
            if (!container) return;
            var afterElement = getDragAfterElement(container, ev.clientY);
            var draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            }
        }

        function drag(ev, taskId) {
            ev.dataTransfer.setData("text", taskId);
            ev.target.classList.add('dragging');
        }

        document.addEventListener('dragend', function(event) {
            // Safe check if target is valid
            if(event.target && event.target.classList && event.target.classList.contains('list-card')) {
                 event.target.classList.remove('dragging');
            }
            // Also cleanup just in case
            var draggingItems = document.querySelectorAll('.dragging');
            draggingItems.forEach(i => i.classList.remove('dragging'));
        });

        function getDragAfterElement(container, y) {
            var draggableElements = [...container.querySelectorAll('.list-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                var box = child.getBoundingClientRect();
                var offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function drop(ev, targetColumnId) {
            ev.preventDefault();
            var taskId = ev.dataTransfer.getData("text");

            var container = ev.target.closest('.list-cards');
            var cardElement = document.querySelector(`.list-card[data-task-id='${taskId}']`);

            if (container && cardElement) {
                 var index = [...container.querySelectorAll('.list-card')].indexOf(cardElement);
                 // Call API with Column ID
                 fetch('/Board/MoveCard?taskId=' + taskId + '&targetColumnId=' + targetColumnId + '&index=' + index, { method: 'POST' });
            }
            
            if(cardElement) cardElement.classList.remove('dragging');
        }

        // Check Logic
        function toggleTask(ev, taskId) {
            ev.preventDefault();
            ev.stopPropagation(); // Prevent card open

            var btn = ev.target.closest('.card-check-btn');
            var title = document.getElementById('title-' + taskId);

            // Toggle visual state
            if (btn.classList.contains('checked')) {
                btn.classList.remove('checked');
                // btn.innerText = ''; // using icon now
                title.classList.remove('completed-task');
            } else {
                btn.classList.add('checked');
                // btn.innerText = '✓'; // using icon now
                title.classList.add('completed-task');
            }

            // Call API
            fetch('/Board/ToggleCard?taskId=' + taskId, { method: 'POST' });
        }

        // Enter to Submit in Composer
        document.addEventListener('keydown', function(event) {
            if (event.target.classList.contains('composer-textarea')) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    event.target.closest('form').querySelector('button[type="submit"]').click();
                }
            }
        });
    </script>
</body>
</html>

